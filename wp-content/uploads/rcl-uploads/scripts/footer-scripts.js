jQuery(function($){ $('#userpicupload').fileupload({ dataType: 'json', type: 'POST', url: wpurl+'wp-admin/admin-ajax.php', formData:{action:'rcl_avatar_upload'}, loadImageMaxFileSize: 2097152, autoUpload:false, previewMaxWidth: 900, previewMaxHeight: 900, imageMinWidth:150, imageMinHeight:150, disableExifThumbnail: true, progressall: function (e, data) { var progress = parseInt(data.loaded / data.total * 100, 10); $('#avatar-upload-progress').show().html('<span>'+progress+'%</span>'); }, processalways: function (e, data) { $.each(data.files, function (index, file) { $('#rcl-preview').remove(); if(file.size>2097152){ rcl_notice('Превышен максимальный размер для изображения! Макс. 2MB','error'); return false; } var canvas = data.files[0].preview; var dataURL = canvas.toDataURL(); $( '#rcl-preview' ).remove(); $('body > div').last().after('<div id=\'rcl-preview\' title=\'Загружаемое изображение\'><img src=\''+dataURL+'\'></div>'); var image = $('#rcl-preview img'); image.load(function() { var img = $(this); var height = img.height(); var width = img.width(); var jcrop_api; img.Jcrop({ aspectRatio: 1, minSize:[150,150], onSelect:function(c){ img.attr('data-width',width).attr('data-height',height).attr('data-x',c.x).attr('data-y',c.y).attr('data-w',c.w).attr('data-h',c.h); } },function(){ jcrop_api = this; }); $( '#rcl-preview' ).dialog({ modal: true, imageQuality: 1, width: width+32, resizable: false, close: function (e, data) { jcrop_api.destroy(); $( '#rcl-preview' ).remove(); }, buttons: { Ok: function() { data.submit(); $( this ).dialog( 'close' ); } } }); }); }); }, submit: function (e, data) { var image = $('#rcl-preview img'); if (parseInt(image.data('w'))){ var src = image.attr('src'); var width = image.data('width'); var height = image.data('height'); var x = image.data('x'); var y = image.data('y'); var w = image.data('w'); var h = image.data('h'); data.formData = { coord: x+','+y+','+w+','+h, image: width+','+height, action:'rcl_avatar_upload' }; } }, done: function (e, data) { if(data.result['error']){ rcl_notice(data.result['error'],'error'); return false; } $('#rcl-contayner-avatar .rcl-user-avatar img').attr('src',data.result['avatar_url']); $('#avatar-upload-progress').hide().empty(); $( '#rcl-preview' ).remove(); rcl_notice(data.result['success'],'success'); } }); $('#webcamupload').click(function(){ $( '#rcl-preview' ).remove(); $('body > div').last().after('<div id=\'rcl-preview\' title=\'Снимок с камеры\'></div>'); var webCam = new SayCheese('#rcl-preview', { audio: true }); $( '#rcl-preview' ).dialog({ modal: true, imageQuality: 1, resizable: false, width:355, close: function (e, data) { webCam.stop(); $( this ).dialog( 'close' ); $( '#rcl-preview' ).remove(); }, open: function (e, data) { webCam.start(); }, buttons: { Снимок: function() { webCam.takeSnapshot(320, 240); } } }); webCam.on('snapshot', function(snapshot) { var img = document.createElement('img'); $(img).on('load', function() { $('#rcl-preview').html(img); }); img.src = snapshot.toDataURL('image/png'); var dataString = 'action=rcl_avatar_upload&src='+img.src; $.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['error']){ rcl_notice(data['error'],'error'); return false; } $( '#rcl-preview' ).dialog('close'); $('#rcl-contayner-avatar .rcl-user-avatar img').attr('src',data['avatar_url']); $( '#rcl-preview' ).remove(); rcl_notice(data['success'],'success'); } }); }); }); $('#lk-content').on('click','.link-file-rcl',function(){ $(this).parent().text('Removes the file from the server'); }); var talker = $('input[name="adressat_mess"]').val(); var online = $('input[name="online"]').val(); $('#upload-private-message').fileupload({ dataType: 'json', type: 'POST', url: wpurl+'wp-admin/admin-ajax.php', formData:{action:'rcl_message_upload',talker:talker,online:online}, loadImageMaxFileSize: 2097152, autoUpload:true, progressall: function (e, data) { var progress = parseInt(data.loaded / data.total * 100, 10); $('#upload-box-message .progress-bar').show().css('width',progress+'px'); }, change:function (e, data) { if(data.files[0]['size']>2097152){ rcl_notice('Превышен максимальный размер для изображения! Макс. 2MB','error'); return false; } }, done: function (e, data) { var result = data.result; if(result['recall']==100){ var text = 'The file was sent successfully.'; } if(result['recall']==150){ var text = 'You have exceeded the limit on the number of uploaded files. Wait until the files sent previously will be accepted.'; } $('.new_mess').replaceWith('<div class="public-post message-block file"><div class="content-mess"><p style="margin-bottom:0px;" class="time-message"><span class="time">'+result['time']+'</span></p><p class="balloon-message">'+text+'</p></div></div><div class="new_mess"></div>'); $('#upload-box-message .progress-bar').hide();var div = $('#resize-content'); div.scrollTop( div.get(0).scrollHeight );} }); $('#groupavatarupload').fileupload({ dataType: 'json', type: 'POST', url: wpurl+'wp-admin/admin-ajax.php', formData:{action:'rcl_group_avatar_upload'}, loadImageMaxFileSize: 2097152, autoUpload:true, imageMinWidth:150, imageMinHeight:150, disableExifThumbnail: true, progressall: function (e, data) { var progress = parseInt(data.loaded / data.total * 100, 10); $('#avatar-upload-progress').show().html('<span>'+progress+'%</span>'); }, submit: function (e, data) { var group_id = $('#groupavatarupload').parents('#rcl-group').data('group'); data.formData = { group_id: group_id, action:'rcl_group_avatar_upload' }; }, done: function (e, data) { if(data.result['error']){ rcl_notice(data.result['error'],'error'); return false; } $('#rcl-group .group-avatar img').attr('src',data.result['avatar_url']); $('#avatar-upload-progress').hide().empty(); rcl_notice(data.result['success'],'success'); } }); rcl_add_dropzone('#rcl-public-dropzone'); var post_id_edit = $('input[name="post-rcl"]').val(); $('#upload-public-form').fileupload({ dataType: 'json', type: 'POST', url: wpurl+'wp-admin/admin-ajax.php', formData:{action:'rcl_imagepost_upload',post_id:post_id_edit}, singleFileUploads:false, autoUpload:true, progressall: function (e, data) { /*var progress = parseInt(data.loaded / data.total * 100, 10); $('#upload-box-message .progress-bar').show().css('width',progress+'px');*/ }, change:function (e, data) { var error = 0; /*rcl_preloader_show('#tab-postform');*/ rcl_preloader_show('.public_block form'); $.each(data.files, function (index, file) { if(file['size']>2097152){ rcl_notice('Превышен максимальный размер для файла '+file['name']+'! Макс. 2MB','error'); rcl_preloader_hide(); error = 1; } }); if(error) return false; }, done: function (e, data) { $.each(data.result, function (index, file) { if(data.result['error']){ rcl_notice(data.result['error'],'error'); rcl_preloader_hide(); return false; } if(file['string']){ $('#temp-files').append(file['string']); } }); rcl_preloader_hide(); } });});
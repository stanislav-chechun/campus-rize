var SliderOptions = '';jQuery(function(){ function setAttr_rcl(prmName,val){ var res = ''; var d = location.href.split('#')[0].split('?'); var base = d[0]; var query = d[1]; if(query) { var params = query.split('&'); for(var i = 0; i < params.length; i++) { var keyval = params[i].split('='); if(keyval[0] != prmName) { res += params[i] + '&'; } } } res += prmName + '=' + val; return base + '?' + res; } function get_ajax_content_tab(id){ var lk = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,'')); var dataString = 'action=rcl_ajax_tab&id='+id+'&lk='+lk+'&locale='+jQuery('html').attr('lang'); jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['result']==100){ jQuery('#lk-content').html(data['content']); } else { alert('Error'); } rcl_preloader_hide(); } }); return false; } jQuery('.rcl-tab-button').on('click','.ajax_button',function(){ if(jQuery(this).hasClass('active'))return false; rcl_preloader_show('#lk-content > div'); var id = jQuery(this).parent().data('tab'); jQuery('.rcl-tab-button .recall-button').removeClass('active'); jQuery(this).addClass('active'); var url = setAttr_rcl('tab',id); if(url != window.location){ if ( history.pushState ){ window.history.pushState(null, null, url); } } get_ajax_content_tab(id); return false; }); var feed_progress = false; var feed_page = 2; jQuery(window).scroll(function(){ if(jQuery(window).scrollTop() + jQuery(window).height() >= jQuery(document).height() - 200 && !feed_progress) { var feed_load = jQuery('#rcl-feed').data('load'); if(feed_load!=='ajax'){ feed_progress = true; return false; } rcl_preloader_show('#feed-preloader > div'); feed_progress = true; var feed_type = jQuery('#rcl-feed').data('feed'); var dataString = 'action=rcl_feed_progress&paged='+feed_page+'&content='+feed_type; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(result){ if(result['code']){ ++feed_page; feed_progress = false; } jQuery('#rcl-feed .feed-box').last().after(result['content']); rcl_preloader_hide(); } }); return false; } }); /* Подписываемся на пользователя */ jQuery('body').on('click','.feed-callback',function(){ var link = jQuery(this); link.removeClass('feed-callback'); var class_i = link.children('i').attr('class'); link.children('i').attr('class','fa fa-refresh fa-spin'); var data = link.data('feed'); var callback = link.data('callback'); var dataString = 'action=rcl_feed_callback&data='+data+'&callback='+callback; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(result){ if(result['success']){ var type = 'success'; } else { var type = 'error'; } if(result['return']=='notice') rcl_notice(result[type],type); if(result['return']=='this') link.parent().html('<span class=\''+type+'\'>'+result[type]+'</span>'); if(result['this']) link.children('span').html(result['this']); if(result['all']){ jQuery('#rcl-feed .user-link-'+data+' a').children('span').html(result['all']); jQuery('#rcl-feed .feed-user-'+data).hide(); } link.addClass('feed-callback'); link.children('i').attr('class',class_i); rcl_preloader_hide(); } }); return false; }); jQuery('#rcl-delete-post .delete-toggle').click(function() { jQuery(this).next().toggle('fast'); return false; }); jQuery('form[name=\'public_post\'] input[name=\'edit-post-rcl\'],form[name=\'public_post\'] input[name=\'add_new_task\']').click(function(){ var error=0; jQuery('form[name=\'public_post\']').find(':input').each(function() { for(var i=0;i<field.length;i++){ if(jQuery(this).attr('name')==field[i]){ if(jQuery(this).val()==''){ jQuery(this).attr('style','border:1px solid red !important'); error=1; }else{ jQuery(this).attr('style','border:1px solid #E6E6E6 !important'); } } } }); if(error==0) return true; else return false; }); jQuery('#rcl-popup').on('click','.rcl-navi.ajax-navi a',function(){ var page = jQuery(this).text(); var dataString = 'action=get_media&user_ID='+user_ID+'&page='+page; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['result']==100){ jQuery('#rcl-overlay').fadeIn(); jQuery('#rcl-popup').html(data['content']); var screen_top = jQuery(window).scrollTop(); var popup_h = jQuery('#rcl-popup').height(); var window_h = jQuery(window).height(); screen_top = screen_top + 60; jQuery('#rcl-popup').css('top', screen_top+'px').delay(100).slideDown(400); }else{ alert('Ошибка!'); } } }); return false; }); jQuery('form #get-media-rcl').click(function(){ var dataString = 'action=get_media&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['result']==100){ jQuery('#rcl-overlay').fadeIn(); jQuery('#rcl-popup').html(data['content']); var screen_top = jQuery(window).scrollTop(); var popup_h = jQuery('#rcl-popup').height(); var window_h = jQuery(window).height(); screen_top = screen_top + 60; jQuery('#rcl-popup').css('top', screen_top+'px').delay(100).slideDown(400); }else{ alert('Ошибка!'); } } }); return false; }); jQuery('#lk-content').on('click','#tab-publics .sec_block_button',function(){ var btn = jQuery(this); get_page_content_rcl(btn,'posts_posts_block'); return false; }); function get_page_content_rcl(btn){ if(btn.hasClass('active'))return false; rcl_preloader_show('#tab-publics'); var id = btn.parents('.recall_child_content_block').attr('id'); var start = btn.attr('data'); var type = btn.attr('type'); var id_user = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,'')); jQuery('.'+id+' .sec_block_button').removeClass('active'); btn.addClass('active'); var dataString = 'action=rcl_posts_list&start='+start+'&type='+type+'&id_user='+id_user; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('#'+id+' .publics-table-rcl').html(data['post_content']); } else { alert('Error'); } rcl_preloader_hide(); } }); return false; } jQuery('#private-smiles').hover( function(){ jQuery('#private-smiles .smiles').show(); }, function(){ jQuery('#private-smiles .smiles').hide(); } ); jQuery('#rcl-new-mess').on('click','.view-form',function(){ jQuery('#rcl-new-mess .prmess').slideDown(); jQuery(this).slideUp(); return false; }); jQuery('.delete_old_message').delay(60000).fadeOut(); function count_word_in_message(word){ var count = 400 - word.val().length; return count; } function get_color_count_word(count){ var color; if(count>150) color = 'green'; if(count<150) color = 'orange'; if(count<50) color = 'red'; return color; } jQuery('#lk-content').on('keyup','#content_mess',function(){ var word = jQuery(this); count = count_word_in_message(word); color = get_color_count_word(count); jQuery('#count-word').css('color', color).text(count); if(word.val().length > 399) word.val(word.val().substr(0, 399)); }); jQuery('#rcl-new-mess').on('keyup','#minicontent_mess',function(){ var word = jQuery(this); count = count_word_in_message(word); color = get_color_count_word(count); jQuery('#minicount-word').css('color', color).text(count); if(word.val().length > 399) word.val(word.val().substr(0, 399)); }); jQuery.ionSound({ sounds: ['e-oh','water_droplet'], path: 'http://localhost/campus-rize/wp-content/plugins/wp-recall/add-on/message/sounds/', multiPlay: false, volume: '0.5' }); /* Добавление личного сообщения */ function add_private_message_recall(){ var content_mess = encodeURIComponent(jQuery('#content_mess').attr('value')); var widget = jQuery('#widget-mess').attr('value'); var adressat_mess = jQuery('#adressat_mess').attr('value'); if(adressat_mess=='0'){ rcl_notice('Выберите собеседника!','error'); return false; } var online = jQuery('#online').attr('value'); max_sec_update_rcl = 0; jQuery('#content_mess').attr('value', ''); if(content_mess) var dataString = 'action=add_private_message_recall&content_mess='+content_mess+'&adressat_mess='+adressat_mess+'&online='+online+'&widget='+widget+'&user_ID='+user_ID; else return false; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('.new_mess').replaceWith(data['message_block']);var div = jQuery('#resize-content'); div.scrollTop( div.get(0).scrollHeight );} if(data['recall']==200){ jQuery('#privatemess').html(data['message_block']).fadeOut(5000); } } }); return false; } jQuery('#lk-content').on('click','.addmess',function(){ var content_text = jQuery('#content_mess').val(); if(content_text) add_private_message_recall(); return false; }); ctrl = false; function breakText() { var caret = jQuery('#content_mess').getSelection().start; jQuery('#content_mess').insertText('\r\n', caret, false).setSelection(caret+1, caret+1); } jQuery('#content_mess').keydown(function(event){ switch (event.which) { case 13: return false; case 17: ctrl = true; } }); jQuery('#content_mess').keyup(function(event){ var content_text = jQuery('#content_mess').val(); switch (event.which) { case 13: if (ctrl){ if(content_text) add_private_message_recall(); return false; } breakText(); break; case 17: ctrl = false; } }); function add_private_minimessage_recall(){ var content_mess = jQuery('#minicontent_mess').attr('value'); var widget = jQuery('#widget-mess').attr('value'); var adressat_mess = jQuery('#miniadressat_mess').attr('value'); if(content_mess) var dataString = 'action=add_private_message_recall&content_mess='+content_mess+'&adressat_mess='+adressat_mess+'&widget='+widget+'&user_ID='+user_ID; else return false; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==200){ jQuery('#privatemess').html(data['message_block']).fadeOut(5000); jQuery('#rcl-new-mess').delay(2000).queue(function () {jQuery('#rcl-new-mess').empty();jQuery('#rcl-new-mess').dequeue();}); } } }); return false; } jQuery('#rcl-new-mess').on('click','.miniaddmess',function(){ var content_text = jQuery('#rcl-new-mess #minicontent_mess').val(); if(content_text) add_private_minimessage_recall(); }); ctrl = false; function minibreakText() { var caret = jQuery('#minicontent_mess').getSelection().start; jQuery('#minicontent_mess').insertText('\r\n', caret, false).setSelection(caret+1, caret+1); } jQuery('#minicontent_mess').keydown(function(event){ switch (event.which) { case 13: return false; case 17: ctrl = true; } }); /* Отмечаем сообщение как прочтенное */ jQuery('#rcl-new-mess').on('click','.close-mess-window',function(){ var id_mess = parseInt(jQuery(this).attr('id').replace(/\D+/g,'')); var dataString = 'action=close_new_message_recall&id_mess='+id_mess+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('#privatemess').html(data['message_block']).fadeOut(5000); jQuery('#rcl-new-mess').delay(2000).queue(function () {jQuery('#rcl-new-mess').empty();jQuery('#rcl-new-mess').dequeue();}); } else { rcl_notice('Ошибка!','error'); } } }); return false; }); /* Добавление в черный список */ jQuery('#manage-blacklist').click(function(){ var user_id = jQuery(this).data('contact'); var dataString = 'action=manage_blacklist_recall&user_id='+user_id; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['otvet']==100){ jQuery('#manage-blacklist').replaceWith(data['content']); } else { rcl_notice('Ошибка!','error'); } } }); return false; }); jQuery('#lk-content').on('click','.remove_black_list',function(){ var id_user = jQuery(this).data('contact'); var dataString = 'action=remove_ban_list_rcl&id_user='+id_user+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['otvet']==100){ jQuery('.history-'+data['id_user']).remove(); } else { rcl_notice('Ошибка!','error'); } } }); return false; }); /* Удаление истории переписки */ jQuery('#lk-content').on('click','.del_history',function(){ var id_user = jQuery(this).data('contact'); var dataString = 'action=delete_history_private_recall&id_user='+id_user+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['otvet']==100){ jQuery('.history-'+data['id_user']).remove(); } else { rcl_notice('Ошибка!','error'); } } }); return false; }); /* Получаем старые сообщения в переписке */ jQuery('#lk-content').on('click','.old_message',function(){ rcl_preloader_show('#tab-privat > div'); block_mess++; var dataString = 'action=get_old_private_message_recall&block_mess='+block_mess+'&old_num_mess='+old_num_mess+'&user='+user_old_mess+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('.old_mess_block').replaceWith(data['message_block']); old_num_mess = data['num_mess_now']; } rcl_preloader_hide(); } }); return false; }); jQuery('#lk-content').on('click','#get-important-rcl',function(){ rcl_preloader_show('#tab-privat > div'); if(jQuery(this).hasClass('important')){ jQuery(this).removeClass('important').text('Вся переписка'); var type = 0; if(block_mess) block_mess = 1; }else{ jQuery(this).addClass('important').text('Важные сообщения'); var type = 1; } var userid = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,'')); var dataString = 'action=get_important_message_rcl&user='+userid+'&type='+type+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('#message-list').html(data['content']); } rcl_preloader_hide(); } }); return false; }); jQuery('#lk-content').on('click','#tab-privat .sec_block_button',function(){ if(jQuery(this).hasClass('active'))return false; rcl_preloader_show('#tab-privat > div'); var days = jQuery(this).attr('data'); jQuery('.correspond .sec_block_button').removeClass('active'); jQuery(this).addClass('active'); var dataString = 'action=get_interval_contacts_rcl&days='+days+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('.correspond #contact-lists').html(data['message_block']); } else { rcl_notice('Ошибка!','error'); } rcl_preloader_hide(); } }); return false; }); jQuery('#lk-content').on('click','#get-all-contacts',function(){ var dataString = 'action=get_interval_contacts_rcl&days=0&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['recall']==100){ jQuery('#rcl-overlay').fadeIn(); jQuery('#rcl-popup').html('<a href=# class=close-popup></a>'+data['message_block']); var screen_top = jQuery(window).scrollTop(); var popup_h = jQuery('#rcl-popup').height(); var window_h = jQuery(window).height(); screen_top = screen_top + 60; jQuery('#rcl-popup').css('top', screen_top+'px').delay(100).slideDown(400); }else{ rcl_notice('Ошибка!','error'); } } }); return false; }); jQuery('#lk-content').on('click','#message-list .important',function(){ update_important_rcl(jQuery(this).attr('idmess')); return false; }); function update_important_rcl(id_mess){ var dataString = 'action=update_important_rcl&id_mess='+id_mess+'&user_ID='+user_ID; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['res']==100) jQuery('#message-'+id_mess+' .important').addClass('active'); if(data['res']==200) jQuery('#message-'+id_mess+' .important').removeClass('active'); } }); return false; } }); function rcl_close_votes_window(e){ jQuery(e).parent().remove(); return false; } function rcl_edit_rating(e){ var block = jQuery(e); var rating = block.data('rating'); var dataString = 'action=rcl_edit_rating_post&rating='+rating; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['error']){ rcl_notice(data['error'],'error'); return false; } if(data['result']==100){ var val = jQuery('.'+data['rating_type']+'-rating-'+data['object_id']+' .rating-value'); val.empty().text(data['rating']); if(data['rating']<0){ val.parent().css('color','#FF0000'); }else{ val.parent().css('color','#008000'); } block.parent().remove(); }else{ rcl_notice('You can not vote!','error'); } } }); return false; } function rcl_get_list_votes(e){ if(jQuery(this).hasClass('active')) return false; rcl_preloader_show('#tab-rating .votes-list'); jQuery('#tab-rating a.get-list-votes').removeClass('active'); jQuery(e).addClass('active'); var rating = jQuery(e).data('rating'); var dataString = 'action=rcl_view_rating_votes&rating='+rating+'&content=list-votes'; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['result']==100){ jQuery('#tab-rating .votes-list').replaceWith(data['window']); }else{ rcl_notice('Error!','error'); } rcl_preloader_hide(); } }); return false; } function rcl_view_list_votes(e){ jQuery('.rating-value-block .votes-window').remove(); var block = jQuery(e); var rating = block.data('rating'); var dataString = 'action=rcl_view_rating_votes&rating='+rating; jQuery.ajax({ type: 'POST', data: dataString, dataType: 'json', url: wpurl+'wp-admin/admin-ajax.php', success: function(data){ if(data['result']==100){ block.after(data['window']); block.next().slideDown(); }else{ rcl_notice('Error!','error'); } } }); return false; } function rcl_zoom_avatar(e){ var link = jQuery(e); var src = link.data('zoom'); jQuery('body > div').last().after('<div id=\'rcl-preview\'><img class=aligncenter src=\''+src+'\'></div>'); jQuery( '#rcl-preview img' ).load(function() { jQuery( '#rcl-preview' ).dialog({ modal: true, draggable: false, imageQuality: 1, resizable: false, width:355, close: function (e, data) { jQuery( this ).dialog( 'close' ); jQuery( '#rcl-preview' ).remove(); }, buttons: { Ок: function() { jQuery( this ).dialog( 'close' ); } } }); }); } function rcl_more_view(e){ var link = jQuery(e); var icon = link.children('i'); link.parent().children('div').slideToggle(); icon.toggleClass('fa-plus-square-o fa-minus-square-o'); }